@page "/contract/download/{ContractId:guid}"
@attribute [StreamRendering]
@rendermode InteractiveServer
@using System.ComponentModel.DataAnnotations
@using AutoDokas.Data.Models
@inherits ComponentBase

<PageTitle>Sutarties atsisiuntimas</PageTitle>

<div class="contract-page">
    @if (loading)
    {
        <div class="status-page">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="status-text mt-3">Kraunami sutarties duomenys...</p>
        </div>
    }
    else if (contract == null)
    {
        <div class="status-page">
            <div class="status-icon status-icon-danger">
                <i class="bi bi-exclamation-circle-fill"></i>
            </div>
            <h2 class="status-title">Sutartis nerasta</h2>
            <p class="status-text">
                Atsiprašome, nepavyko rasti jūsų sutarties. Patikrinkite nuorodą ir bandykite dar kartą.
            </p>
            <a href="/" class="btn btn-cta">
                Grįžti į pradžią <i class="bi bi-arrow-right ms-2"></i>
            </a>
        </div>
    }
    else
    {
        <div class="contract-page-header">
            <h1 class="contract-page-title">Sutarties atsisiuntimas</h1>
        </div>

        <div class="download-card">
            <div class="download-card-header">
                Sutarties informacija
            </div>
            <div class="download-card-body">
                <div class="row">
                    <div class="col-md-4 mb-2">
                        <small class="text-muted d-block">Automobilis</small>
                        <strong>@(contract.VehicleInfo?.Make ?? "-") @(contract.VehicleInfo?.RegistrationNumber ?? "-")</strong>
                    </div>
                    <div class="col-md-4 mb-2">
                        <small class="text-muted d-block">Sutarties Sudarymmo Data</small>
                        <strong>@contract.CreatedAt.ToLongDateString()</strong>
                    </div>
                </div>
            </div>
        </div>

        @if (!isVerified)
        {
            <div class="download-card">
                <div class="download-card-header">
                    <i class="bi bi-shield-lock me-2"></i>Tapatybės patvirtinimas
                </div>
                <div class="download-card-body">
                    <p class="text-muted mb-3" style="font-size: 0.9rem;">
                        Įveskite savo el. pašto adresą, kad patvirtintumėte savo tapatybę prieš atsisiųsdami sutartį.
                    </p>

                    <EditForm Model="verificationModel" OnValidSubmit="VerifyEmail">
                        <DataAnnotationsValidator />

                        <div class="mb-3">
                            <label for="email" class="form-label">El. pašto adresas *</label>
                            <InputText id="email" @bind-Value="verificationModel.Email" class="form-control" />
                            <ValidationMessage For="@(() => verificationModel.Email)" />

                            @if (showEmailError)
                            {
                                <div class="text-danger small mt-1">
                                    Įvestas el. pašto adresas neatitinka mūsų įrašų. Bandykite dar kartą.
                                </div>
                            }
                        </div>

                        <button type="submit" class="btn-section-next">
                            <i class="bi bi-shield-check"></i> Patvirtinti
                        </button>
                    </EditForm>
                </div>
            </div>
        }
        else
        {
            <div class="status-page" style="padding-top: 2rem;">
                <div class="status-icon status-icon-success">
                    <i class="bi bi-check-circle-fill"></i>
                </div>
                <h2 class="status-title">Tapatybė patvirtinta!</h2>
                <p class="status-text">
                    Jūsų el. paštas patvirtintas. Dabar galite atsisiųsti sutarties dokumentą.
                </p>
                <a href="@GetDownloadUrl()" class="btn btn-cta" target="_blank" style="background: #16a34a; border-color: #16a34a;">
                    <i class="bi bi-file-earmark-pdf me-2"></i> Atsisiųsti sutartį (PDF)
                </a>
            </div>
        }
    }
</div>
